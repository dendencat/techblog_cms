{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="editor-container" style="display: flex; height: 80vh; gap: 20px; padding: 20px;">
  <!-- ã‚¨ãƒ‡ã‚£ã‚¿å´ (30%) -->
  <div class="editor-section" style="flex: 0 0 30%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">è¨˜äº‹ã‚¨ãƒ‡ã‚£ã‚¿</h2>

    {% if error %}
    <div class="alert alert-danger" style="margin-bottom: 20px;">{{ error }}</div>
    {% endif %}

    <form method="post" id="articleForm" action="{% url 'article_new' %}" style="display: flex; flex-direction: column; height: 100%;">
      {% if not IS_TESTING %}
      {% csrf_token %}
      {% endif %}

      <div class="form-group" style="margin-bottom: 15px;">
        <label for="title" style="font-weight: bold;">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input id="title" name="title" type="text" class="form-control" required
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
      </div>

      <!-- æ›¸å¼ãƒãƒ¼ -->
      <div class="formatting-toolbar" style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
        <button type="button" class="format-btn" data-format="h1" title="è¦‹å‡ºã—1">H1</button>
        <button type="button" class="format-btn" data-format="h2" title="è¦‹å‡ºã—2">H2</button>
        <button type="button" class="format-btn" data-format="h3" title="è¦‹å‡ºã—3">H3</button>
        <button type="button" class="format-btn" data-format="bold" title="å¤ªå­—"><strong>B</strong></button>
        <button type="button" class="format-btn" data-format="italic" title="æ–œä½“"><em>I</em></button>
        <button type="button" class="format-btn" data-format="link" title="ãƒªãƒ³ã‚¯">ğŸ”—</button>
        <button type="button" class="format-btn" data-format="code" title="ã‚³ãƒ¼ãƒ‰">`</button>
        <button type="button" class="format-btn" data-format="list" title="ãƒªã‚¹ãƒˆ">â€¢</button>
        <button type="button" class="format-btn" data-format="quote" title="å¼•ç”¨">"</button>
      </div>

      <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
        <label for="content" style="font-weight: bold; margin-bottom: 5px;">æœ¬æ–‡ (Markdown)</label>
        <textarea id="content" name="content" class="form-control markdown-editor"
                  style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; resize: none;"
                  placeholder="ã“ã“ã«è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      </div>

      <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
      <div class="button-group" style="margin-top: 20px; display: flex; gap: 10px;">
        <button type="submit" name="action" value="save" class="btn btn-secondary"
                style="padding: 10px 20px; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; cursor: pointer;">
          ğŸ’¾ ä¿å­˜
        </button>
        <button type="submit" name="action" value="publish" class="btn btn-primary"
                style="padding: 10px 20px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer;">
          ğŸš€ å…¬é–‹
        </button>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary"
           style="padding: 10px 20px; border: 1px solid #6c757d; color: #6c757d; text-decoration: none; border-radius: 4px;">
          æˆ»ã‚‹
        </a>
      </div>
    </form>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ (30%) -->
  <div class="preview-section" style="flex: 0 0 30%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <div id="preview" class="markdown-preview"
         style="flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; overflow-y: auto;">
      <p style="color: #6c757d; font-style: italic;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</p>
    </div>
  </div>

  <!-- ãƒ˜ãƒ«ãƒ—å´ (40%) -->
  <div class="help-section" style="flex: 0 0 40%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">Markdown ãƒ˜ãƒ«ãƒ—</h2>
    <div class="help-content" style="flex: 1; overflow-y: auto;">
      <h3>åŸºæœ¬çš„ãªæ›¸å¼</h3>
      <ul>
        <li><code># è¦‹å‡ºã—1</code> - è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«1</li>
        <li><code>## è¦‹å‡ºã—2</code> - è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«2</li>
        <li><code>**å¤ªå­—**</code> - å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆ</li>
        <li><code>*æ–œä½“*</code> - æ–œä½“ãƒ†ã‚­ã‚¹ãƒˆ</li>
        <li><code>[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)</code> - ãƒªãƒ³ã‚¯</li>
        <li><code>`ã‚³ãƒ¼ãƒ‰`</code> - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</li>
        <li><code>```è¨€èªå\nã‚³ãƒ¼ãƒ‰\n```</code> - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯</li>
        <li><code>- é …ç›®</code> - ãƒªã‚¹ãƒˆ</li>
        <li><code>> å¼•ç”¨</code> - å¼•ç”¨æ–‡</li>
      </ul>

      <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼</h3>
      <ul>
        <li><kbd>Ctrl+B</kbd> - å¤ªå­—</li>
        <li><kbd>Ctrl+I</kbd> - æ–œä½“</li>
        <li><kbd>Ctrl+K</kbd> - ãƒªãƒ³ã‚¯</li>
        <li><kbd>Ctrl+Shift+K</kbd> - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯</li>
        <li><kbd>Ctrl+Shift+7</kbd> - é †åºä»˜ããƒªã‚¹ãƒˆ</li>
        <li><kbd>Ctrl+Shift+8</kbd> - é †åºãªã—ãƒªã‚¹ãƒˆ</li>
      </ul>
    </div>
  </div>
</div>

<style>
.formatting-toolbar .format-btn {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background-color: white;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  min-width: 30px;
}

.formatting-toolbar .format-btn:hover {
  background-color: #f0f0f0;
}

.markdown-preview h1 { font-size: 1.8em; margin: 0.5em 0; }
.markdown-preview h2 { font-size: 1.5em; margin: 0.5em 0; }
.markdown-preview h3 { font-size: 1.3em; margin: 0.5em 0; }
.markdown-preview p { margin: 0.5em 0; }
.markdown-preview code { background-color: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
.markdown-preview pre { background-color: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
.markdown-preview blockquote { border-left: 4px solid #ddd; padding-left: 10px; margin: 10px 0; color: #666; }
.markdown-preview ul, .markdown-preview ol { margin: 10px 0; padding-left: 20px; }
.markdown-preview a { color: #007bff; text-decoration: none; }
.markdown-preview a:hover { text-decoration: underline; }
</style>

<script>
// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›é–¢æ•°
function markdownToHtml(markdown) {
  // åŸºæœ¬çš„ãªå¤‰æ›å‡¦ç†
  let html = markdown
    // è¦‹å‡ºã—
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // å¤ªå­—
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // æ–œä½“
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // ãƒªãƒ³ã‚¯
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // ãƒªã‚¹ãƒˆ
    .replace(/^\- (.*$)/gim, '<li>$1</li>')
    // å¼•ç”¨
    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
    // æ”¹è¡Œ
    .replace(/\n/g, '<br>');

  // é€£ç¶šã—ãŸliã‚¿ã‚°ã‚’ulã§å›²ã‚€
  html = html.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');

  return html;
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°
function updatePreview() {
  const content = document.getElementById('content').value;
  const preview = document.getElementById('preview');
  if (content.trim() === '') {
    preview.innerHTML = '<p style="color: #6c757d; font-style: italic;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</p>';
  } else {
    preview.innerHTML = markdownToHtml(content);
  }
}

// æ›¸å¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
function applyFormatting(format) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';

  switch(format) {
    case 'h1':
      replacement = '# ' + selectedText;
      break;
    case 'h2':
      replacement = '## ' + selectedText;
      break;
    case 'h3':
      replacement = '### ' + selectedText;
      break;
    case 'bold':
      replacement = selectedText ? '**' + selectedText + '**' : '****';
      break;
    case 'italic':
      replacement = selectedText ? '*' + selectedText + '*' : '**';
      break;
    case 'link':
      replacement = selectedText ? '[' + selectedText + '](URL)' : '[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)';
      break;
    case 'code':
      replacement = selectedText ? '`' + selectedText + '`' : '``';
      break;
    case 'list':
      if (selectedText) {
        // é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¤‡æ•°è¡Œã«åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆåŒ–
        const lines = selectedText.split('\n');
        replacement = lines.map(line => line.trim() ? '- ' + line : line).join('\n');
      } else {
        replacement = '- ';
      }
      break;
    case 'quote':
      replacement = selectedText ? '> ' + selectedText : '> ';
      break;
  }

  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®èª¿æ•´
  const newCursorPos = start + replacement.length;
  textarea.setSelectionRange(newCursorPos, newCursorPos);

  updatePreview();
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('content');
  const formatBtns = document.querySelectorAll('.format-btn');

  // å…¥åŠ›æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  textarea.addEventListener('input', updatePreview);

  // æ›¸å¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  formatBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²ã
      e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
      const format = this.getAttribute('data-format');
      applyFormatting(format);
    });
  });

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'b':
          e.preventDefault();
          applyFormatting('bold');
          break;
        case 'i':
          e.preventDefault();
          applyFormatting('italic');
          break;
        case 'k':
          e.preventDefault();
          applyFormatting('link');
          break;
      }
    }
  });

  // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  updatePreview();
});
</script>
{% endblock %}
