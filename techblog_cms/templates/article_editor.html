{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="editor-container w-full px-4 py-4 lg:py-6">
  <div class="flex flex-col lg:flex-row gap-6">
  <!-- エディタ -->
  <div class="editor-section flex-1 min-w-0 flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">記事エディタ</h2>

    {% if error %}
    <div class="alert alert-danger" style="margin-bottom: 20px;">{{ error }}</div>
    {% endif %}

    <form method="post" id="articleForm" action="{% url 'article_new' %}" class="flex flex-col h-full">
      {% csrf_token %}

      <div class="form-group mb-4">
        <label for="title" class="font-bold">タイトル</label>
        <input id="title" name="title" type="text" required
               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-blue-200" />
      </div>

      <!-- 書式バー -->
      <div class="formatting-toolbar mb-2 flex gap-2 flex-wrap">
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h1" title="見出し1" aria-label="見出し1">H1</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h2" title="見出し2" aria-label="見出し2">H2</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h3" title="見出し3" aria-label="見出し3">H3</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="bold" title="太字" aria-label="太字"><strong>B</strong></button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="italic" title="斜体" aria-label="斜体"><em>I</em></button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="link" title="リンク" aria-label="リンク">🔗</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="code" title="コード" aria-label="コード">`</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="list" title="リスト" aria-label="リスト">•</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="quote" title="引用" aria-label="引用">"</button>
      </div>

      <div class="form-group flex-1 flex flex-col">
        <label for="content" class="font-bold mb-1">本文 (Markdown)</label>
        <textarea id="content" name="content"
                  class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-md font-mono focus:outline-none focus:ring focus:ring-blue-200 resize-y"
                  style="min-height: 24rem;"
                  placeholder="ここに記事を書いてください..."></textarea>
      </div>

      <!-- ボタンエリア -->
      <div class="button-group mt-4 flex gap-3">
        <button type="submit" name="action" value="publish" class="px-5 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">🚀 公開</button>
        <button type="submit" name="action" value="save" class="px-5 py-2 rounded bg-gray-700 text-white hover:bg-gray-800">💾 保存</button>
        <a href="{% url 'dashboard' %}" class="px-5 py-2 rounded border border-gray-400 text-gray-700 hover:bg-gray-50">戻る</a>
      </div>
    </form>
  </div>

  <!-- プレビュー -->
  <div class="preview-section flex-1 min-w-0 flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">プレビュー</h2>
    <div id="preview" class="markdown-preview flex-1 p-4 border border-gray-300 rounded bg-gray-50 overflow-y-auto">
      <p class="text-gray-500 italic">プレビューがここに表示されます...</p>
    </div>
  </div>

  <!-- ヘルプ（デスクトップは右、モバイルは下） -->
  <div class="help-section lg:w-80 w-full flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">Markdown ヘルプ</h2>
    <div class="help-content flex-1 overflow-y-auto p-2">
      <h3>基本的な書式</h3>
      <ul>
        <li><code># 見出し1</code> - 見出しレベル1</li>
        <li><code>## 見出し2</code> - 見出しレベル2</li>
        <li><code>**太字**</code> - 太字テキスト</li>
        <li><code>*斜体*</code> - 斜体テキスト</li>
        <li><code>[リンクテキスト](URL)</code> - リンク</li>
        <li><code>`コード`</code> - インラインコード</li>
        <li><code>```言語名\nコード\n```</code> - コードブロック</li>
        <li><code>- 項目</code> - リスト</li>
        <li><code>> 引用</code> - 引用文</li>
      </ul>

      <h3>ショートカットキー</h3>
      <ul>
        <li><kbd>Ctrl+B</kbd> - 太字</li>
        <li><kbd>Ctrl+I</kbd> - 斜体</li>
        <li><kbd>Ctrl+K</kbd> - リンク</li>
        <li><kbd>Ctrl+Shift+K</kbd> - コードブロック</li>
        <li><kbd>Ctrl+Shift+7</kbd> - 順序付きリスト</li>
        <li><kbd>Ctrl+Shift+8</kbd> - 順序なしリスト</li>
      </ul>
    </div>
  </div>
  </div>
</div>

<style>
.formatting-toolbar .format-btn {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background-color: white;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  min-width: 30px;
}

.formatting-toolbar .format-btn:hover {
  background-color: #f0f0f0;
}

.markdown-preview h1 { font-size: 1.8em; margin: 0.5em 0; }
.markdown-preview h2 { font-size: 1.5em; margin: 0.5em 0; }
.markdown-preview h3 { font-size: 1.3em; margin: 0.5em 0; }
.markdown-preview p { margin: 0.5em 0; }
.markdown-preview code { background-color: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
.markdown-preview pre { background-color: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
.markdown-preview blockquote { border-left: 4px solid #ddd; padding-left: 10px; margin: 10px 0; color: #666; }
.markdown-preview ul, .markdown-preview ol { margin: 10px 0; padding-left: 20px; }
.markdown-preview a { color: #007bff; text-decoration: none; }
.markdown-preview a:hover { text-decoration: underline; }
</style>

<script>
// マークダウン変換関数
function markdownToHtml(markdown) {
  // 基本的な変換処理
  let html = markdown
    // 見出し
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // 太字
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // 斜体
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // インラインコード
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // リンク
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // リスト
    .replace(/^\- (.*$)/gim, '<li>$1</li>')
    // 引用
    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
    // 改行
    .replace(/\n/g, '<br>');

  // 連続したliタグをulで囲む
  html = html.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');

  return html;
}

// プレビュー更新関数
// 簡易debounce
function debounce(fn, delay) {
  let t = null;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

async function serverRenderMarkdown(markdown) {
  try {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const resp = await fetch('/api/preview_markdown/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: 'text=' + encodeURIComponent(markdown || '')
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    return data.html || '';
  } catch (e) {
    return markdownToHtml(markdown || '');
  }
}

async function updatePreview() {
  const content = document.getElementById('content').value;
  const preview = document.getElementById('preview');
  if (content.trim() === '') {
    preview.innerHTML = '<p class="text-gray-500 italic">プレビューがここに表示されます...</p>';
  } else {
    const html = await serverRenderMarkdown(content);
    preview.innerHTML = html;
  }
}
const updatePreviewDebounced = debounce(updatePreview, 250);

// 書式ボタンの処理
function applyFormatting(format) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';

  switch(format) {
    case 'h1':
      replacement = '# ' + selectedText;
      break;
    case 'h2':
      replacement = '## ' + selectedText;
      break;
    case 'h3':
      replacement = '### ' + selectedText;
      break;
    case 'bold':
      replacement = selectedText ? '**' + selectedText + '**' : '****';
      break;
    case 'italic':
      replacement = selectedText ? '*' + selectedText + '*' : '**';
      break;
    case 'link':
      replacement = selectedText ? '[' + selectedText + '](URL)' : '[リンクテキスト](URL)';
      break;
    case 'code':
      replacement = selectedText ? '`' + selectedText + '`' : '``';
      break;
    case 'list':
      if (selectedText) {
        // 選択されたテキストを複数行に分割してリスト化
        const lines = selectedText.split('\n');
        replacement = lines.map(line => line.trim() ? '- ' + line : line).join('\n');
      } else {
        replacement = '- ';
      }
      break;
    case 'quote':
      replacement = selectedText ? '> ' + selectedText : '> ';
      break;
  }

  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();

  // カーソル位置の調整
  const newCursorPos = start + replacement.length;
  textarea.setSelectionRange(newCursorPos, newCursorPos);

  updatePreview();
}

// イベントリスナーの設定
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('content');
  const formatBtns = document.querySelectorAll('.format-btn');

  // 入力時のプレビュー更新（debounce）
  textarea.addEventListener('input', updatePreviewDebounced);

  // スクロール同期（比率ベースの簡易同期）
  const preview = document.getElementById('preview');
  textarea.addEventListener('scroll', function() {
    const ratio = textarea.scrollTop / (textarea.scrollHeight - textarea.clientHeight || 1);
    preview.scrollTop = ratio * (preview.scrollHeight - preview.clientHeight);
  });

  // 書式ボタンのクリック処理
  formatBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // フォーム送信を防ぐ
      e.stopPropagation(); // イベントの伝播を止める
      const format = this.getAttribute('data-format');
      applyFormatting(format);
    });
  });

  // キーボードショートカット
  textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'b':
          e.preventDefault();
          applyFormatting('bold');
          break;
        case 'i':
          e.preventDefault();
          applyFormatting('italic');
          break;
        case 'k':
          e.preventDefault();
          applyFormatting('link');
          break;
      }
    }
  });

  // 初期プレビュー更新
  updatePreview();
});
</script>
{% endblock %}
