{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="editor-container" style="display: flex; height: 80vh; gap: 20px; padding: 20px;">
  <!-- エディタ側 (30%) -->
  <div class="editor-section" style="flex: 0 0 30%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">記事エディタ</h2>

    {% if error %}
    <div class="alert alert-danger" style="margin-bottom: 20px;">{{ error }}</div>
    {% endif %}

    <form method="post" id="articleForm" action="{% url 'article_new' %}" style="display: flex; flex-direction: column; height: 100%;">
      {% if not IS_TESTING %}
      {% csrf_token %}
      {% endif %}

      <div class="form-group" style="margin-bottom: 15px;">
        <label for="title" style="font-weight: bold;">タイトル</label>
        <input id="title" name="title" type="text" class="form-control" required
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
      </div>

      <!-- 書式バー -->
      <div class="formatting-toolbar" style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
        <button type="button" class="format-btn" data-format="h1" title="見出し1">H1</button>
        <button type="button" class="format-btn" data-format="h2" title="見出し2">H2</button>
        <button type="button" class="format-btn" data-format="h3" title="見出し3">H3</button>
        <button type="button" class="format-btn" data-format="bold" title="太字"><strong>B</strong></button>
        <button type="button" class="format-btn" data-format="italic" title="斜体"><em>I</em></button>
        <button type="button" class="format-btn" data-format="link" title="リンク">🔗</button>
        <button type="button" class="format-btn" data-format="code" title="コード">`</button>
        <button type="button" class="format-btn" data-format="list" title="リスト">•</button>
        <button type="button" class="format-btn" data-format="quote" title="引用">"</button>
      </div>

      <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
        <label for="content" style="font-weight: bold; margin-bottom: 5px;">本文 (Markdown)</label>
        <textarea id="content" name="content" class="form-control markdown-editor"
                  style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; resize: none;"
                  placeholder="ここに記事を書いてください..."></textarea>
      </div>

      <!-- ボタンエリア -->
      <div class="button-group" style="margin-top: 20px; display: flex; gap: 10px;">
        <button type="submit" name="action" value="save" class="btn btn-secondary"
                style="padding: 10px 20px; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; cursor: pointer;">
          💾 保存
        </button>
        <button type="submit" name="action" value="publish" class="btn btn-primary"
                style="padding: 10px 20px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer;">
          🚀 公開
        </button>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary"
           style="padding: 10px 20px; border: 1px solid #6c757d; color: #6c757d; text-decoration: none; border-radius: 4px;">
          戻る
        </a>
      </div>
    </form>
  </div>

  <!-- プレビュー側 (30%) -->
  <div class="preview-section" style="flex: 0 0 30%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">プレビュー</h2>
    <div id="preview" class="markdown-preview"
         style="flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; overflow-y: auto;">
      <p style="color: #6c757d; font-style: italic;">プレビューがここに表示されます...</p>
    </div>
  </div>

  <!-- ヘルプ側 (40%) -->
  <div class="help-section" style="flex: 0 0 40%; display: flex; flex-direction: column;">
    <h2 style="margin-bottom: 20px;">Markdown ヘルプ</h2>
    <div class="help-content" style="flex: 1; overflow-y: auto;">
      <h3>基本的な書式</h3>
      <ul>
        <li><code># 見出し1</code> - 見出しレベル1</li>
        <li><code>## 見出し2</code> - 見出しレベル2</li>
        <li><code>**太字**</code> - 太字テキスト</li>
        <li><code>*斜体*</code> - 斜体テキスト</li>
        <li><code>[リンクテキスト](URL)</code> - リンク</li>
        <li><code>`コード`</code> - インラインコード</li>
        <li><code>```言語名\nコード\n```</code> - コードブロック</li>
        <li><code>- 項目</code> - リスト</li>
        <li><code>> 引用</code> - 引用文</li>
      </ul>

      <h3>ショートカットキー</h3>
      <ul>
        <li><kbd>Ctrl+B</kbd> - 太字</li>
        <li><kbd>Ctrl+I</kbd> - 斜体</li>
        <li><kbd>Ctrl+K</kbd> - リンク</li>
        <li><kbd>Ctrl+Shift+K</kbd> - コードブロック</li>
        <li><kbd>Ctrl+Shift+7</kbd> - 順序付きリスト</li>
        <li><kbd>Ctrl+Shift+8</kbd> - 順序なしリスト</li>
      </ul>
    </div>
  </div>
</div>

<style>
.formatting-toolbar .format-btn {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background-color: white;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  min-width: 30px;
}

.formatting-toolbar .format-btn:hover {
  background-color: #f0f0f0;
}

.markdown-preview h1 { font-size: 1.8em; margin: 0.5em 0; }
.markdown-preview h2 { font-size: 1.5em; margin: 0.5em 0; }
.markdown-preview h3 { font-size: 1.3em; margin: 0.5em 0; }
.markdown-preview p { margin: 0.5em 0; }
.markdown-preview code { background-color: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
.markdown-preview pre { background-color: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
.markdown-preview blockquote { border-left: 4px solid #ddd; padding-left: 10px; margin: 10px 0; color: #666; }
.markdown-preview ul, .markdown-preview ol { margin: 10px 0; padding-left: 20px; }
.markdown-preview a { color: #007bff; text-decoration: none; }
.markdown-preview a:hover { text-decoration: underline; }
</style>

<script>
// マークダウン変換関数
function markdownToHtml(markdown) {
  // 基本的な変換処理
  let html = markdown
    // 見出し
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // 太字
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // 斜体
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // インラインコード
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // リンク
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // リスト
    .replace(/^\- (.*$)/gim, '<li>$1</li>')
    // 引用
    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
    // 改行
    .replace(/\n/g, '<br>');

  // 連続したliタグをulで囲む
  html = html.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');

  return html;
}

// プレビュー更新関数
function updatePreview() {
  const content = document.getElementById('content').value;
  const preview = document.getElementById('preview');
  if (content.trim() === '') {
    preview.innerHTML = '<p style="color: #6c757d; font-style: italic;">プレビューがここに表示されます...</p>';
  } else {
    preview.innerHTML = markdownToHtml(content);
  }
}

// 書式ボタンの処理
function applyFormatting(format) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';

  switch(format) {
    case 'h1':
      replacement = '# ' + selectedText;
      break;
    case 'h2':
      replacement = '## ' + selectedText;
      break;
    case 'h3':
      replacement = '### ' + selectedText;
      break;
    case 'bold':
      replacement = selectedText ? '**' + selectedText + '**' : '****';
      break;
    case 'italic':
      replacement = selectedText ? '*' + selectedText + '*' : '**';
      break;
    case 'link':
      replacement = selectedText ? '[' + selectedText + '](URL)' : '[リンクテキスト](URL)';
      break;
    case 'code':
      replacement = selectedText ? '`' + selectedText + '`' : '``';
      break;
    case 'list':
      if (selectedText) {
        // 選択されたテキストを複数行に分割してリスト化
        const lines = selectedText.split('\n');
        replacement = lines.map(line => line.trim() ? '- ' + line : line).join('\n');
      } else {
        replacement = '- ';
      }
      break;
    case 'quote':
      replacement = selectedText ? '> ' + selectedText : '> ';
      break;
  }

  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();

  // カーソル位置の調整
  const newCursorPos = start + replacement.length;
  textarea.setSelectionRange(newCursorPos, newCursorPos);

  updatePreview();
}

// イベントリスナーの設定
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('content');
  const formatBtns = document.querySelectorAll('.format-btn');

  // 入力時のプレビュー更新
  textarea.addEventListener('input', updatePreview);

  // 書式ボタンのクリック処理
  formatBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // フォーム送信を防ぐ
      e.stopPropagation(); // イベントの伝播を止める
      const format = this.getAttribute('data-format');
      applyFormatting(format);
    });
  });

  // キーボードショートカット
  textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'b':
          e.preventDefault();
          applyFormatting('bold');
          break;
        case 'i':
          e.preventDefault();
          applyFormatting('italic');
          break;
        case 'k':
          e.preventDefault();
          applyFormatting('link');
          break;
      }
    }
  });

  // 初期プレビュー更新
  updatePreview();
});
</script>
{% endblock %}
