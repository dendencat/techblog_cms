{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="editor-container w-full px-4 py-4 lg:py-6">
  <div class="flex flex-col lg:flex-row gap-6">
  <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
  <div class="editor-section flex-1 min-w-0 flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">è¨˜äº‹ã‚¨ãƒ‡ã‚£ã‚¿</h2>

    {% if error %}
    <div class="alert alert-danger" style="margin-bottom: 20px;">{{ error }}</div>
    {% endif %}

    <form method="post" id="articleForm" action="{% url 'article_new' %}" class="flex flex-col h-full">
      {% csrf_token %}

      <div class="form-group mb-4">
        <label for="title" class="font-bold">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input id="title" name="title" type="text" required
               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-blue-200" />
      </div>

      <!-- æ›¸å¼ãƒãƒ¼ -->
      <div class="formatting-toolbar mb-2 flex gap-2 flex-wrap">
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h1" title="è¦‹å‡ºã—1" aria-label="è¦‹å‡ºã—1">H1</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h2" title="è¦‹å‡ºã—2" aria-label="è¦‹å‡ºã—2">H2</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="h3" title="è¦‹å‡ºã—3" aria-label="è¦‹å‡ºã—3">H3</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="bold" title="å¤ªå­—" aria-label="å¤ªå­—"><strong>B</strong></button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="italic" title="æ–œä½“" aria-label="æ–œä½“"><em>I</em></button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="link" title="ãƒªãƒ³ã‚¯" aria-label="ãƒªãƒ³ã‚¯">ğŸ”—</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="code" title="ã‚³ãƒ¼ãƒ‰" aria-label="ã‚³ãƒ¼ãƒ‰">`</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="list" title="ãƒªã‚¹ãƒˆ" aria-label="ãƒªã‚¹ãƒˆ">â€¢</button>
        <button type="button" class="format-btn px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200" data-format="quote" title="å¼•ç”¨" aria-label="å¼•ç”¨">"</button>
      </div>

      <div class="form-group flex-1 flex flex-col">
        <label for="content" class="font-bold mb-1">æœ¬æ–‡ (Markdown)</label>
        <textarea id="content" name="content"
                  class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-md font-mono focus:outline-none focus:ring focus:ring-blue-200 resize-y"
                  style="min-height: 24rem;"
                  placeholder="ã“ã“ã«è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      </div>

      <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
      <div class="button-group mt-4 flex gap-3">
        <button type="submit" name="action" value="publish" class="px-5 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">ğŸš€ å…¬é–‹</button>
        <button type="submit" name="action" value="save" class="px-5 py-2 rounded bg-gray-700 text-white hover:bg-gray-800">ğŸ’¾ ä¿å­˜</button>
        <a href="{% url 'dashboard' %}" class="px-5 py-2 rounded border border-gray-400 text-gray-700 hover:bg-gray-50">æˆ»ã‚‹</a>
      </div>
    </form>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="preview-section flex-1 min-w-0 flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <div id="preview" class="markdown-preview flex-1 p-4 border border-gray-300 rounded bg-gray-50 overflow-y-auto">
      <p class="text-gray-500 italic">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</p>
    </div>
  </div>

  <!-- ãƒ˜ãƒ«ãƒ—ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯å³ã€ãƒ¢ãƒã‚¤ãƒ«ã¯ä¸‹ï¼‰ -->
  <div class="help-section lg:w-80 w-full flex flex-col">
    <h2 class="mb-5 text-xl font-semibold">Markdown ãƒ˜ãƒ«ãƒ—</h2>
    <div class="help-content flex-1 overflow-y-auto p-2">
      <h3>åŸºæœ¬çš„ãªæ›¸å¼</h3>
      <ul>
        <li><code># è¦‹å‡ºã—1</code> - è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«1</li>
        <li><code>## è¦‹å‡ºã—2</code> - è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«2</li>
        <li><code>**å¤ªå­—**</code> - å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆ</li>
        <li><code>*æ–œä½“*</code> - æ–œä½“ãƒ†ã‚­ã‚¹ãƒˆ</li>
        <li><code>[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)</code> - ãƒªãƒ³ã‚¯</li>
        <li><code>`ã‚³ãƒ¼ãƒ‰`</code> - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</li>
        <li><code>```è¨€èªå\nã‚³ãƒ¼ãƒ‰\n```</code> - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯</li>
        <li><code>- é …ç›®</code> - ãƒªã‚¹ãƒˆ</li>
        <li><code>> å¼•ç”¨</code> - å¼•ç”¨æ–‡</li>
      </ul>

      <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼</h3>
      <ul>
        <li><kbd>Ctrl+B</kbd> - å¤ªå­—</li>
        <li><kbd>Ctrl+I</kbd> - æ–œä½“</li>
        <li><kbd>Ctrl+K</kbd> - ãƒªãƒ³ã‚¯</li>
        <li><kbd>Ctrl+Shift+K</kbd> - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯</li>
        <li><kbd>Ctrl+Shift+7</kbd> - é †åºä»˜ããƒªã‚¹ãƒˆ</li>
        <li><kbd>Ctrl+Shift+8</kbd> - é †åºãªã—ãƒªã‚¹ãƒˆ</li>
      </ul>
    </div>
  </div>
  </div>
</div>

<style>
.formatting-toolbar .format-btn {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background-color: white;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  min-width: 30px;
}

.formatting-toolbar .format-btn:hover {
  background-color: #f0f0f0;
}

.markdown-preview h1 { font-size: 1.8em; margin: 0.5em 0; }
.markdown-preview h2 { font-size: 1.5em; margin: 0.5em 0; }
.markdown-preview h3 { font-size: 1.3em; margin: 0.5em 0; }
.markdown-preview p { margin: 0.5em 0; }
.markdown-preview code { background-color: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
.markdown-preview pre { background-color: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
.markdown-preview blockquote { border-left: 4px solid #ddd; padding-left: 10px; margin: 10px 0; color: #666; }
.markdown-preview ul, .markdown-preview ol { margin: 10px 0; padding-left: 20px; }
.markdown-preview a { color: #007bff; text-decoration: none; }
.markdown-preview a:hover { text-decoration: underline; }
</style>

<script>
// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›é–¢æ•°
function markdownToHtml(markdown) {
  // åŸºæœ¬çš„ãªå¤‰æ›å‡¦ç†
  let html = markdown
    // è¦‹å‡ºã—
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // å¤ªå­—
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // æ–œä½“
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // ãƒªãƒ³ã‚¯
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // ãƒªã‚¹ãƒˆ
    .replace(/^\- (.*$)/gim, '<li>$1</li>')
    // å¼•ç”¨
    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
    // æ”¹è¡Œ
    .replace(/\n/g, '<br>');

  // é€£ç¶šã—ãŸliã‚¿ã‚°ã‚’ulã§å›²ã‚€
  html = html.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');

  return html;
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°
// ç°¡æ˜“debounce
function debounce(fn, delay) {
  let t = null;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

async function serverRenderMarkdown(markdown) {
  try {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const resp = await fetch('/api/preview_markdown/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: 'text=' + encodeURIComponent(markdown || '')
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    return data.html || '';
  } catch (e) {
    return markdownToHtml(markdown || '');
  }
}

async function updatePreview() {
  const content = document.getElementById('content').value;
  const preview = document.getElementById('preview');
  if (content.trim() === '') {
    preview.innerHTML = '<p class="text-gray-500 italic">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</p>';
  } else {
    const html = await serverRenderMarkdown(content);
    preview.innerHTML = html;
  }
}
const updatePreviewDebounced = debounce(updatePreview, 250);

// æ›¸å¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
function applyFormatting(format) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';

  switch(format) {
    case 'h1':
      replacement = '# ' + selectedText;
      break;
    case 'h2':
      replacement = '## ' + selectedText;
      break;
    case 'h3':
      replacement = '### ' + selectedText;
      break;
    case 'bold':
      replacement = selectedText ? '**' + selectedText + '**' : '****';
      break;
    case 'italic':
      replacement = selectedText ? '*' + selectedText + '*' : '**';
      break;
    case 'link':
      replacement = selectedText ? '[' + selectedText + '](URL)' : '[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)';
      break;
    case 'code':
      replacement = selectedText ? '`' + selectedText + '`' : '``';
      break;
    case 'list':
      if (selectedText) {
        // é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¤‡æ•°è¡Œã«åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆåŒ–
        const lines = selectedText.split('\n');
        replacement = lines.map(line => line.trim() ? '- ' + line : line).join('\n');
      } else {
        replacement = '- ';
      }
      break;
    case 'quote':
      replacement = selectedText ? '> ' + selectedText : '> ';
      break;
  }

  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®èª¿æ•´
  const newCursorPos = start + replacement.length;
  textarea.setSelectionRange(newCursorPos, newCursorPos);

  updatePreview();
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('content');
  const formatBtns = document.querySelectorAll('.format-btn');

  // å…¥åŠ›æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆdebounceï¼‰
  textarea.addEventListener('input', updatePreviewDebounced);

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸï¼ˆæ¯”ç‡ãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“åŒæœŸï¼‰
  const preview = document.getElementById('preview');
  textarea.addEventListener('scroll', function() {
    const ratio = textarea.scrollTop / (textarea.scrollHeight - textarea.clientHeight || 1);
    preview.scrollTop = ratio * (preview.scrollHeight - preview.clientHeight);
  });

  // æ›¸å¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  formatBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²ã
      e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
      const format = this.getAttribute('data-format');
      applyFormatting(format);
    });
  });

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'b':
          e.preventDefault();
          applyFormatting('bold');
          break;
        case 'i':
          e.preventDefault();
          applyFormatting('italic');
          break;
        case 'k':
          e.preventDefault();
          applyFormatting('link');
          break;
      }
    }
  });

  // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  updatePreview();
});
</script>
{% endblock %}
